# 同花顺(Tonghuashun) 技术架构深度分析

## 文档概述

**分析目标**: 深入分析同花顺股票交易软件的技术实现，为 lumos-stock 的 Tauri 迁移和架构优化提供参考

**分析日期**: 2025-01-19

**参考项目**: 同花顺 (10jqka.com.cn) - 中国领先的股票交易软件

---

## 1. 技术栈全景

### 1.1 客户端架构

| 平台 | 技术栈 | 特点 |
|------|--------|------|
| **PC 客户端** | C++ + MFC/Qt | 高性能、低延迟、成熟稳定 |
| **Android** | Java/Kotlin (Native) | 原生体验、完全系统集成 |
| **iOS** | Swift/Objective-C (Native) | 原生体验、Metal 加速 |
| **Web** | HTML5 + WebSocket | 跨平台访问、轻量级 |

### 1.2 后端架构

```
┌─────────────────────────────────────────────────────────┐
│                    负载均衡层 (Nginx/LVS)                  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   API 网关层 (Kong/APISIX)                 │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              微服务层 (gRPC 通信)                          │
│  ┌──────────┬──────────┬──────────┬──────────┐          │
│  │ 行情服务 │ 交易服务 │ AI分析服务 │ 用户服务 │          │
│  └──────────┴──────────┴──────────┴──────────┘          │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              数据层 (TDengine + Redis)                    │
└─────────────────────────────────────────────────────────┘
```

### 1.3 核心技术组件

| 组件 | 技术选型 | 用途 |
|------|----------|------|
| **时序数据库** | TDengine | 存储秒级行情数据，支持 30,000 行/秒写入 |
| **缓存** | Redis | 热点数据缓存、会话管理 |
| **消息队列** | Kafka/RocketMQ | 异步任务处理、事件驱动 |
| **RPC 框架** | gRPC | 内部服务通信，高性能二进制协议 |
| **实时推送** | WebSocket/TCP | Level-2 高速行情推送 |
| **AI 框架** | 自研 4 层架构 | 业务层 → Agent层 → 数据层 → 模型层 |

---

## 2. 架构设计模式

### 2.1 微服务架构

```
同花顺微服务拆分模式：

┌──────────────────┐
│  用户认证服务      │ - JWT 验证、单点登录、权限管理
├──────────────────┤
│  行情数据服务      │ - 实时行情、历史K线、技术指标计算
├──────────────────┤
│  交易执行服务      │ - 订单提交、成交查询、持仓管理
├──────────────────┤
│  AI 分析服务       │ - 智能选股、策略回测、风险评估
├──────────────────┤
│  消息推送服务      │ - 实时提醒、公告推送、个性化通知
├──────────────────┤
│  数据采集服务      │ - 爬虫系统、数据清洗、入库存储
└──────────────────┘
```

**关键特点**:
- **独立部署**: 每个服务可独立扩容和升级
- **故障隔离**: 单个服务故障不影响整体系统
- **技术异构**: 不同服务可选择最适合的技术栈
- **数据去中心化**: 每个服务管理自己的数据库

### 2.2 4 层 AI Agent 架构

```
┌─────────────────────────────────────────────────────────┐
│                    业务层 (Business Layer)                │
│  - 交易策略定义、用户意图理解、业务规则引擎                 │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    Agent 层 (Agent Layer)                 │
│  - 任务规划、工具调用、多 Agent 协作、推理控制              │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    数据层 (Data Layer)                    │
│  - 数据源接入、特征工程、数据清洗、缓存管理                 │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   模型层 (Model Layer)                    │
│  - LLM 集成、预测模型、分类模型、强化学习                   │
└─────────────────────────────────────────────────────────┘
```

**与 lumos-stock 的对比**:

| 维度 | 同花顺 | lumos-stock |
|------|--------|-------------|
| **架构复杂度** | 4 层架构，多 Agent 协作 | 单层架构，直接调用 |
| **数据源管理** | 独立数据层，多源融合 | 硬编码数据源，耦合严重 |
| **模型集成** | 统一模型层，支持多模型 | 分散在各个 API 中 |
| **任务规划** | Agent 层自动规划 | 前端硬编码流程 |

### 2.3 实时数据推送架构

```
同花顺 Level-2 高速行情推送：

交易所/数据源
      ↓
  [数据清洗层]  ← 数据验证、格式化、压缩
      ↓
  [TDengine]   ← 时序数据库存储 (30,000 行/秒)
      ↓
  [计算引擎]    ← 技术指标实时计算 (MA、MACD、KDJ...)
      ↓
  [推送网关]    ← WebSocket 长连接管理、消息分发
      ↓
┌─────────┬─────────┬─────────┐
│ PC客户端 │ 移动端   │ Web端   │  ← TCP/WebSocket 双通道
└─────────┴─────────┴─────────┘
```

**推送性能指标**:
- **延迟**: Level-2 行情 < 50ms
- **并发**: 支持百万级长连接
- **吞吐**: 单服务器 10 万 QPS
- **可靠性**: 消息送达率 99.99%

**lumos-stock 当前方案**:
- **轮询模式**: 前端定时调用 API (1-3 秒间隔)
- **延迟**: 1-3 秒 (取决于轮询频率)
- **资源浪费**: 大量无效请求，无数据变化也消耗带宽
- **服务器压力**: 高峰期容易超载

---

## 3. 数据架构设计

### 3.1 TDengine 时序数据库

**为什么选择 TDengine**:

| 特性 | TDengine | SQLite (lumos-stock 当前) |
|------|----------|---------------------------|
| **写入性能** | 30,000 行/秒 | < 100 行/秒 |
| **压缩比** | 10:1 (无损失) | 3:1 |
| **查询性能** | 毫秒级 (亿级数据) | 秒级 (百万级数据) |
| **分区** | 自动时间分区 | 手动管理 |
| **降采样** | 内置聚合函数 | 应用层计算 |

**数据模型示例**:

```sql
-- 同花顺行情表设计 (TDengine)
CREATE STABLE stock_candle (
    ts TIMESTAMP,           -- 时间戳 (主键)
    open DOUBLE,            -- 开盘价
    high DOUBLE,            -- 最高价
    low DOUBLE,             -- 最低价
    close DOUBLE,           -- 收盘价
    volume BIGINT,          -- 成交量
    amount DOUBLE           -- 成交额
) TAGS (code NCHAR(10), market NCHAR(10));  -- 标签：股票代码、市场

-- 自动分区：按天、按股票代码
-- 查询示例：最近 1000 根 K 线
SELECT * FROM stock_candle WHERE code='600519' ORDER BY ts DESC LIMIT 1000;
```

**lumos-stock 当前设计 (SQLite)**:

```sql
-- 简单表结构，无分区
CREATE TABLE stock_kline (
    id INTEGER PRIMARY KEY,
    code TEXT,
    date TEXT,
    open REAL,
    high REAL,
    low REAL,
    close REAL,
    volume INTEGER
);
-- 查询性能：全表扫描，无索引优化
```

### 3.2 数据分层架构

```
同花顺数据分层：

┌─────────────────────────────────────┐
│       热数据层 (Redis)               │
│  - 最近 1 分钟行情                  │
│  - 用户会话信息                     │
│  - 实时计算缓存                     │
│  内存: 50GB                         │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│    温数据层 (TDengine)               │
│  - 最近 1 年 K 线数据               │
│  - 技术指标计算结果                 │
│  磁盘: 2TB                          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│    冷数据层 (HDFS/对象存储)          │
│  - 历史完整数据 (10 年+)            │
│  - 归档日志                         │
│  磁盘: 100TB+                       │
└─────────────────────────────────────┘
```

**数据生命周期管理**:
- **热数据**: 高频访问，毫秒级响应，自动降级到温数据
- **温数据**: 中频访问，秒级响应，定期归档到冷数据
- **冷数据**: 低频访问，分钟级响应，低成本存储

---

## 4. 移动端实现策略

### 4.1 原生开发 vs 跨平台

| 维度 | 同花顺选择 | Tauri 方案 | Wails 方案 |
|------|-----------|-----------|-----------|
| **iOS** | Swift (Native) | ✅ 支持 (2.0+) | ❌ 不支持 |
| **Android** | Kotlin (Native) | ✅ 支持 (2.0+) | ❌ 不支持 |
| **性能** | 100% 原生 | 95-98% 原生 | 不适用 |
| **包大小** | ~50MB | ~15MB | 不适用 |
| **开发成本** | 高 (双团队) | 中 (单代码库) | 低 (仅桌面) |

### 4.2 移动端特化优化

**同花顺移动端优化点**:

1. **数据压缩**
   - Protobuf 二进制协议 (比 JSON 小 50-70%)
   - GZIP/Brotli 压缩
   - 增量更新 (只传输变化部分)

2. **离线缓存**
   - SQLite 本地数据库
   - 关键数据预加载
   - 离线模式支持

3. **性能优化**
   - 虚拟列表 (Virtualized Scrolling)
   - 图片懒加载
   - 智能预加载 (预测用户行为)

4. **电池优化**
   - 后台任务限制
   - 网络请求合并
   - 自适应刷新频率

**lumos-stock 移动端改造建议**:

```javascript
// 虚拟列表实现 (使用 NaiveUI)
<n-virtual-list
  :items="stockList"
  :item-size="80"
  :page-size="20"
>
  <template #default="{ item }">
    <stock-item :data="item" />
  </template>
</n-virtual-list>

// 智能刷新策略 (根据网络环境自适应)
const updateInterval = navigator.connection
  ? navigator.connection.saveData ? 5000 : 2000  // 省流模式 5 秒
  : 3000;  // 默认 3 秒
```

---

## 5. 对 lumos-stock 的启示

### 5.1 架构演进路径

```
当前架构 (lumos-stock):
  前端 (Vue 3) ←→ Wails IPC ←→ Go 单体应用

阶段 1: Tauri 迁移 (6-9 周)
  前端 (Vue 3) ←→ Tauri ←→ Go HTTP 服务 (Sidecar)

阶段 2: 实时推送优化 (4-6 周)
  前端 (Vue 3) ←→ WebSocket ←→ Go HTTP 服务 + 推送服务

阶段 3: 数据库升级 (6-8 周)
  SQLite → TDengine/InfluxDB (时序数据库)

阶段 4: 微服务拆分 (12-16 周)
  单体 Go → Go 微服务集群 (行情/交易/AI/用户)

阶段 5: 移动端支持 (8-10 周)
  Tauri 桌面 → Tauri 桌面 + 移动端 (iOS/Android)
```

### 5.2 关键优化建议

| 优化项 | 当前方案 | 建议方案 | 优先级 | 预期收益 |
|--------|----------|----------|--------|----------|
| **实时推送** | 轮询 (1-3s) | WebSocket | 🔴 高 | 延迟降低 95% |
| **数据库** | SQLite | TDengine | 🟡 中 | 查询性能提升 100x |
| **缓存** | 无 | Redis | 🟡 中 | 并发能力提升 10x |
| **移动端** | 无 | Tauri 2.0 | 🔴 高 | 新增 iOS/Android |
| **API 设计** | 80+ RPC | RESTful + GraphQL | 🟢 低 | 前后端解耦 |
| **监控** | 日志文件 | Prometheus + Grafana | 🟡 中 | 可观测性提升 |

### 5.3 Tauri 迁移中的应用

**直接可借鉴的实践**:

1. **保持 Go 后端** (类似同花顺的 C++ 核心)
   - Rust 作为轻量级胶水层
   - Go 处理业务逻辑 (代码复用 90%)
   - Sidecar 模式提供进程隔离

2. **WebSocket 实时推送**
   - Tauri 前端建立 WebSocket 长连接
   - Go 后端推送实时行情
   - 取消前端轮询，降低资源消耗

3. **响应式设计**
   - 学习同花顺移动端的布局策略
   - NaiveUI Grid 组件实现自适应
   - 虚拟列表优化长列表性能

4. **渐进式架构升级**
   - 不必一次性重构为微服务
   - 先迁移到 Tauri，再逐步优化
   - 保持业务连续性

---

## 6. 性能对比分析

### 6.1 实时推送 vs 轮询

| 指标 | 轮询模式 (当前) | WebSocket (推荐) | 提升 |
|------|----------------|-----------------|------|
| **数据延迟** | 1-3 秒 | < 100ms | 30x |
| **网络流量** | 10 MB/小时 (持续) | 2 MB/小时 (按需) | 5x |
| **服务器负载** | 1000 QPS (高峰) | 200 QPS (事件) | 5x |
| **电量消耗** | 高 (持续唤醒) | 低 (长连接休眠) | 3x |
| **实现复杂度** | 简单 | 中等 | - |

### 6.2 数据库性能对比

| 操作 | SQLite | TDengine | 提升 |
|------|--------|----------|------|
| **写入性能** | 100 行/秒 | 30,000 行/秒 | 300x |
| **查询性能** (百万行) | 2-5 秒 | 50-100ms | 50x |
| **存储空间** | 10 GB | 1 GB (压缩) | 10x |
| **并发连接** | 1 (写锁) | 1000+ | 1000x |

---

## 7. 实施建议

### 7.1 短期优化 (1-3 个月)

1. **Tauri 迁移** (已在计划中)
   - 保持前端代码 100% 复用
   - Go 后端改为 HTTP 服务
   - 逐步添加 WebSocket 推送

2. **实时推送试点**
   - 选择关键 API (如自选股行情)
   - 实现 WebSocket 推送
   - A/B 测试效果

3. **响应式改造**
   - 修复 154 处硬编码宽度
   - 添加移动端适配
   - 测试主流设备 (iPhone, Android)

### 7.2 中期优化 (3-6 个月)

1. **数据库迁移**
   - 评估 TDengine vs InfluxDB
   - 数据迁移工具开发
   - 双写验证 (SQLite + 新库)

2. **缓存层建设**
   - Redis 部署
   - 热点数据缓存策略
   - 缓存失效机制

3. **监控体系**
   - Prometheus metrics
   - Grafana 可视化
   - 告警规则配置

### 7.3 长期演进 (6-12 个月)

1. **微服务拆分**
   - 按业务域拆分服务
   - gRPC 内部通信
   - API 网关统一入口

2. **AI 架构升级**
   - 实现 4 层 AI Agent 架构
   - 多模型集成管理
   - 智能策略推荐

3. **移动端独立优化**
   - iOS/Android 原生模块 (如需要)
   - 移动端性能专项优化
   - 应用商店上架

---

## 8. 风险评估

| 风险项 | 影响 | 概率 | 缓解措施 |
|--------|------|------|----------|
| **WebSocket 稳定性** | 高 | 中 | 实现自动重连、降级到轮询 |
| **数据库迁移** | 高 | 低 | 充分测试、灰度发布、回滚方案 |
| **移动端性能** | 中 | 中 | 性能测试、渐进式优化 |
| **微服务复杂度** | 高 | 低 | 先做单体优化、按需拆分 |
| **技术栈学习** | 低 | 高 | 团队培训、技术预研 |

---

## 9. 总结

**同花顺的核心优势**:
1. **成熟的技术栈**: C++/Qt 保证性能、TDengine 保证数据处理能力
2. **微服务架构**: 弹性伸缩、故障隔离、独立部署
3. **实时推送**: WebSocket 低延迟、高并发、可靠送达
4. **原生移动端**: iOS/Android 原生体验、性能优化
5. **AI 智能化**: 4 层架构、多模型集成、智能推荐

**对 lumos-stock 的借鉴意义**:
1. **不必追求完美架构**: 同花顺也是逐步演进而来
2. **实时推送是刚需**: 从轮询升级到 WebSocket 是关键一步
3. **数据架构很重要**: SQLite 到 TDengine 的升级值得考虑
4. **移动端是趋势**: Tauri 2.0 提供了跨平台移动端的机会
5. **AI 能力需要架构支持**: 4 层 AI Agent 架构可参考

**下一步行动**:
1. 继续推进 Tauri 迁移计划 (已在 tauri.md 中定义)
2. 在 Tauri 迁移完成后,优先实现 WebSocket 实时推送
3. 评估 TDengine/InfluxDB 作为数据库升级方案
4. 逐步完善移动端适配 (响应式设计、性能优化)

---

**参考文档**:
- [TDengine 官方文档](https://www.taosdata.com/docs)
- [Tauri 2.0 移动端支持](https://tauri.app/v2/guides/)
- [gRPC 官方文档](https://grpc.io/docs/)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
